name: Update from DEV

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Create API PR and Merge
        run: |
          echo "Criando PR via API GitHub..."
          
          # Criar PR usando API
          pr_response=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d '{
              "title": "Update from DEV branch",
              "head": "dev",
              "base": "main", 
              "body": "Automated PR"
            }')
            
          echo "Resposta API PR: $pr_response"
          
          # Extrair número do PR
          pr_number=$(echo $pr_response | grep -o '"number": [0-9]*' | grep -o '[0-9]*' | head -1)
          
          if [ -z "$pr_number" ]; then
            echo "Falha ao criar PR ou extrair número."
            echo "Resposta completa:"
            echo "$pr_response"
            exit 1
          fi
          
          echo "PR #$pr_number criado com sucesso."
          
          # Fazer merge do PR
          echo "Fazendo merge do PR #$pr_number..."
          merge_response=$(curl -s -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number/merge \
            -d '{
              "merge_method": "merge",
              "commit_title": "Merge dev into main via workflow",
              "commit_message": "Atualização automática do branch main a partir do dev"
            }')
            
          echo "Resposta do merge: $merge_response"
          
          # Verificar se o merge foi bem-sucedido
          merged=$(echo $merge_response | grep -o '"merged": true' || echo "")
          if [ -z "$merged" ]; then
            echo "Falha ao fazer merge do PR. Resposta completa:"
            echo "$merge_response"
            exit 1
          fi
          
          echo "PR #$pr_number mesclado com sucesso!"
          echo "Branch dev sincronizado com main. O workflow de deploy deve ser acionado automaticamente."